<!DOCTYPE html>

<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Çok Sınıflı Kitaplık Yönetimi</title>
<!-- Roboto fontu için Google Fonts linki -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&amp;display=swap" rel="stylesheet"/>
<style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f8ff;
            margin: 0;
            padding: 0;
        }
        header {
            text-align: center;
            background-color: #FFA500;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            position: relative;
            margin: 20px;
        }
        header h1 {
            color: #fff;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
        }
        header img {
            width: 100px;
            height: 100px;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }
        button {
            background-color: #007bb5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            margin: 10px;
            font-size: 1em;
        }
        button:hover {
            background-color: #005f8c;
            transform: scale(1.05);
        }
        #delete-student, #delete-book {
            background-color: #d9534f;
        }
        #delete-student:hover, #delete-book:hover {
            background-color: #c9302c;
        }
        #best-button {
            background-color: #28a745;
        }
        #best-button:hover {
            background-color: #218838;
        }
        table {
            width: 90%;
            margin: 20px auto;
            border-collapse: collapse;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            background-color: #fff;
            border-radius: 10px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
            transition: background-color 0.3s;
        }
        th {
            background-color: #007bb5;
            color: white;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        .ongoing td {
            color: #ff4500;
        }
        .completed td {
            color: #28a745;
        }
        #pin-section, #edit-section {
            text-align: center;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            width: 60%;
        }
        #edit-section {
            display: none;
        }
        #student-book-management div {
            margin: 15px 0;
        }
        #student-book-management input, #student-book-management select {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            width: calc(50% - 140px);
            margin-right: 10px;
        }
        #reading-history-section, #best-section {
            text-align: center;
            margin: 20px auto;
            width: 80%;
        }
        #reading-history-table, #best-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            background-color: #fff;
            border-radius: 10px;
            overflow: hidden;
        }
        .top-three {
            font-weight: bold;
            color: #d4af37;
            position: relative;
            animation: borderPulse 1.5s infinite;
        }
        @keyframes borderPulse {
            0% {
                box-shadow: 0 0 5px 3px rgba(255, 215, 0, 0.5);
            }
            50% {
                box-shadow: 0 0 10px 5px rgba(255, 215, 0, 1);
            }
            100% {
                box-shadow: 0 0 5px 3px rgba(255, 215, 0, 0.5);
            }
        }

        /* "İşlemler" sütunu varsayılan olarak gizlenir */
        .action-column, .action-cell {
            display: none;
        }

        /* "edit-mode" sınıfı aktifken "İşlemler" sütunu görünür olur */
        .edit-mode .action-column, 
        .edit-mode .action-cell {
            display: table-cell;
        }

        /* Modal Styles */
        dialog {
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            padding: 20px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        #modal-content p {
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        #modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        #modal-buttons button {
            padding: 10px 20px;
            font-size: 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #modal-buttons .ok-btn {
            background-color: #0078d7;
            color: white;
        }

        #modal-buttons .cancel-btn {
            background-color: #6c757d;
            color: white;
        }

        #modal-buttons .confirm-btn {
            background-color: #28a745;
            color: white;
        }

        #modal-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 1em;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: none;
        }

        /* Yeni Stil Eklemeleri */
        .return-book {
            background-color: #ff6347; /* Kırmızı */
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        .return-book:hover {
            background-color: #ff4500; /* Daha koyu kırmızı */
            transform: scale(1.05);
        }
        .return-book:disabled {
            background-color: #28a745; /* Yeşil */
            cursor: not-allowed;
            transform: none;
        }

        /* Teslim Edildi butonu için özel stil */
        .return-book.completed {
            background-color: #28a745; /* Yeşil */
            cursor: default;
        }
        .return-book.completed:hover {
            background-color: #28a745;
            transform: none;
        }

        /* Silme Butonu Stili */
        .delete-assignment {
            background-color: #dc3545; /* Kırmızı */
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-size: 0.9em;
        }

        .delete-assignment:hover {
            background-color: #c82333; /* Daha koyu kırmızı */
            transform: scale(1.1);
        }
    </style>
<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js";
        import { getDatabase, ref, set, get, child, push, remove, update, onValue } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-database.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "sinif-kutuphane-alc.firebaseapp.com",
            databaseURL: "https://sinif-kutuphane-alc-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "sinif-kutuphane-alc",
            storageBucket: "sinif-kutuphane-alc.appspot.com",
            messagingSenderId: "184048570892",
            appId: "1:184048570892:web:76302a4eb4c26bba83d429",
            measurementId: "G-RNXHPXG1ME"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        document.addEventListener("DOMContentLoaded", function() {
            const mainElement = document.querySelector("main"); // 'edit-mode' sınıfını eklemek için main elementi
            const classSelect = document.getElementById("class-select");
            let classID = null; // Başlangıçta seçili sınıf yok
            let isEditMode = false; // Düzenleme modunu takip eder

            const studentHistorySelect = document.getElementById("student-history-select");
            const listHistoryButton = document.getElementById("list-history");
            const readingHistoryTable = document.getElementById("reading-history-table");
            const readingHistoryBody = document.getElementById("reading-history");
            const booksTableBody = document.getElementById("books");
            const studentSelect = document.getElementById("student-select");
            const bookSelect = document.getElementById("book-select");
            const bestButton = document.getElementById("best-button");
            const historyButton = document.getElementById("history-button");
            const bestSection = document.getElementById("best-section");
            const readingHistorySection = document.getElementById("reading-history-section");
            
            const pinSection = document.getElementById("pin-section");
            const pinInput = document.getElementById("pin-input");
            const pinSubmit = document.getElementById("pin-submit");
            const editSection = document.getElementById("edit-section");
            const saveButton = document.getElementById("save-button");
            const editButton = document.getElementById("edit-button");

            const addStudentButton = document.getElementById("add-student");
            const deleteStudentButton = document.getElementById("delete-student");
            const addBookButton = document.getElementById("add-book");
            const deleteBookButton = document.getElementById("delete-book");
            const assignBookButton = document.getElementById("assign-book");

            // Modal Elements
            const modal = document.getElementById("modal");
            const modalMessage = document.getElementById("modal-message");
            const modalButtons = document.getElementById("modal-buttons");
            const modalInput = document.getElementById("modal-input");
            const okBtn = document.querySelector(".ok-btn");
            const cancelBtn = document.querySelector(".cancel-btn");
            const confirmBtn = document.querySelector(".confirm-btn");

            // Helper function to parse "dd.MM.yyyy" to Date object
            function parseDate(dateStr) {
                if (!dateStr) return new Date(0); // Return a very old date if undefined
                const parts = dateStr.split('.');
                if (parts.length !== 3) return new Date(0); // Geçersiz format
                const [day, month, year] = parts;
                return new Date(`${year}-${month}-${day}`); // ISO format
            }

            // Function to format Date object to "dd.MM.yyyy"
            function formatDate(date) {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}.${month}.${year}`;
            }

            // Function to show alert modal
            function showAlert(message) {
                return new Promise((resolve) => {
                    modalMessage.textContent = message;
                    modalInput.style.display = "none";
                    cancelBtn.style.display = "none";
                    confirmBtn.style.display = "none";
                    okBtn.style.display = "inline-block";
                    okBtn.textContent = "Tamam";
                    modal.showModal();

                    okBtn.onclick = () => {
                        modal.close();
                        resolve();
                    };
                });
            }

            // Function to show confirm modal
            function showConfirm(message) {
                return new Promise((resolve) => {
                    modalMessage.textContent = message;
                    modalInput.style.display = "none";
                    cancelBtn.style.display = "inline-block";
                    confirmBtn.style.display = "none";
                    okBtn.style.display = "inline-block";
                    okBtn.textContent = "Evet";
                    cancelBtn.textContent = "Hayır";
                    modal.showModal();

                    okBtn.onclick = () => {
                        modal.close();
                        resolve(true);
                    };

                    cancelBtn.onclick = () => {
                        modal.close();
                        resolve(false);
                    };
                });
            }

            // Sınıfları dinamik olarak yükle ve class-select dropdown'una ekle
            function loadClassesDropdown() {
                const classesRef = ref(database, 'classes');
                onValue(classesRef, (snapshot) => {
                    classSelect.innerHTML = '<option value="">Sınıf Seçin</option>'; // İlk seçeneği ekle
                    if (snapshot.exists()) {
                        const classes = snapshot.val();
                        for (let cls in classes) {
                            const option = document.createElement("option");
                            option.value = cls;
                            option.textContent = cls;
                            classSelect.appendChild(option);
                        }
                    } else {
                        showAlert("Hiç sınıf yok");
                    }
                });
            }

            loadClassesDropdown(); // Sayfa yüklendiğinde sınıfları yükle

            // Sınıf seçildiğinde
            classSelect.addEventListener("change", async () => {
                classID = classSelect.value;
                if (classID) {
                    clearUI();
                    closeEditMode();
                    await loadAllData();
                } else {
                    clearUI();
                    closeEditMode();
                }
            });

            function clearUI() {
                studentHistorySelect.innerHTML = '<option value="">Öğrenci Seçin</option>';
                studentSelect.innerHTML = '<option value="">Öğrenci Seçin</option>';
                bookSelect.innerHTML = '<option value="">Kitap Seçin</option>';
                booksTableBody.innerHTML = "";
                readingHistoryBody.innerHTML = "";
                readingHistoryTable.style.display = "none";
                bestSection.style.display = "none";
                readingHistorySection.style.display = "none";
            }

            async function loadAllData() {
                await loadDataFromFirebase();
                await loadStudents();
                await loadBooksList();
            }

            // Düzenleme modunu kapatma fonksiyonu
            function closeEditMode() {
                editSection.style.display = "none";
                pinSection.style.display = "none";
                isEditMode = false;
                mainElement.classList.remove("edit-mode"); // 'edit-mode' sınıfını kaldır
                updateReturnButtons();
                loadDataFromFirebase(); // Silme butonlarını kaldırmak için verileri tekrar yükle
                pinInput.value = "";
            }

            // Kitap atamaları (books) verisini yükler
            async function loadDataFromFirebase() {
                const booksRef = ref(database, 'classes/' + classID + '/books');
                try {
                    const snapshot = await get(booksRef);
                    if (snapshot.exists()) {
                        const booksData = snapshot.val();
                        let books = [];
                        for (let key in booksData) {
                            books.push({ key: key, ...booksData[key] });
                        }

                        // Sıralama: önce 'okuyor' durumundakiler en üstte, sonra 'tamamlandı' durumundakiler
                        books.sort((a, b) => {
                            // Duruma göre sırala: 'okuyor' önce, 'tamamlandı' sonra
                            if (a.status !== b.status) {
                                return a.status === 'okuyor' ? -1 : 1;
                            }

                            // Aynı durumda ise, 'okuyor' için borrowDate, 'tamamlandı' için returnDate'e göre sırala
                            if (a.status === 'okuyor') {
                                const dateA = parseDate(a.borrowDate);
                                const dateB = parseDate(b.borrowDate);
                                return dateB - dateA; // En son alınan en üstte
                            } else {
                                const dateA = parseDate(a.returnDate);
                                const dateB = parseDate(b.returnDate);
                                return dateB - dateA; // En son teslim edilen en üstte
                            }
                        });

                        // En fazla 50 satır gözüksün
                        books = books.slice(0, 50);
                        booksTableBody.innerHTML = "";
                        books.forEach(book => {
                            const row = document.createElement("tr");
                            row.className = book.status === "okuyor" ? "ongoing" : "completed";
                            row.setAttribute('data-key', book.key); // Firebase anahtarını satıra ekleyin

                            // Butonun durumuna göre sınıf ekleyerek renklerini belirleyelim
                            let returnButtonClass = "return-book";
                            let returnButtonText = "Teslim Et";
                            let returnButtonDisabled = !isEditMode || book.status !== "okuyor";

                            if (book.status === "tamamlandı") {
                                returnButtonClass += " completed";
                                returnButtonText = "Teslim Edildi";
                                returnButtonDisabled = true;
                            }

                            // Silme butonu için HTML
                            let deleteButtonHTML = '';
                            if (isEditMode) { // Sadece düzenleme modundayken silme butonu göster
                                deleteButtonHTML = `<button class="delete-assignment" title="Sil" style="margin-left: 5px;">&#10006;</button>`;
                            }

                            row.innerHTML = `
                                <td>${book.studentName}</td>
                                <td>${book.bookName}</td>
                                <td>${book.borrowDate}</td>
                                <td>${book.status === "okuyor" ? "Okuyor" : (book.returnDate ? book.returnDate : "Tamamlandı")}</td>
                                <td class="action-cell">
                                    <button class="${returnButtonClass}" ${returnButtonDisabled ? 'disabled' : ''}>${returnButtonText}</button>
                                    ${deleteButtonHTML}
                                </td>
                            `;
                            booksTableBody.appendChild(row);
                        });
                        updateReturnButtons();

                        // Sıralanmış kitapları konsola yazdır (Debug amaçlı)
                        console.log("Sıralanmış Kitaplar:", books);
                    } else {
                        booksTableBody.innerHTML = "";
                        updateReturnButtons();
                    }
                } catch (error) {
                    console.error("Veri yükleme hatası:", error);
                    await showAlert("Veri yükleme hatası: " + error.message);
                }
            }

            // Tüm öğrencileri yükler ve Türkçe alfabetik sıralar
            async function loadStudents() {
                const studentsRef = ref(database, 'classes/' + classID + '/students');
                try {
                    const snapshot = await get(studentsRef);
                    if (snapshot.exists()) {
                        let students = Object.values(snapshot.val());
                        // Öğrencileri Türkçe alfabe sırasına göre sıralama
                        students.sort((a, b) => a.studentName.localeCompare(b.studentName, 'tr'));

                        const existingStudentValues = Array.from(studentSelect.options).map(opt => opt.value);
                        const existingHistoryValues = Array.from(studentHistorySelect.options).map(opt => opt.value);

                        students.forEach(student => {
                            if (!existingStudentValues.includes(student.studentName)) {
                                const option = document.createElement("option");
                                option.value = student.studentName;
                                option.textContent = student.studentName;
                                studentSelect.appendChild(option);
                            }
                            if (!existingHistoryValues.includes(student.studentName)) {
                                const historyOption = document.createElement("option");
                                historyOption.value = student.studentName;
                                historyOption.textContent = student.studentName;
                                studentHistorySelect.appendChild(historyOption);
                            }
                        });
                    }
                } catch (error) {
                    console.error("Öğrenci yükleme hatası:", error);
                    await showAlert("Öğrenci yükleme hatası: " + error.message);
                }
            }

            // Tüm kitapları yükler ve Türkçe alfabetik sıralar
            async function loadBooksList() {
                const booksListRef = ref(database, 'classes/' + classID + '/booksList');
                try {
                    const snapshot = await get(booksListRef);
                    if (snapshot.exists()) {
                        let booksList = Object.values(snapshot.val());
                        // Kitapları Türkçe alfabe sırasına göre sıralama
                        booksList.sort((a,b) => a.bookName.localeCompare(b.bookName, 'tr'));

                        const existingBookValues = Array.from(bookSelect.options).map(opt => opt.value);

                        booksList.forEach(book => {
                            if (!existingBookValues.includes(book.bookName)) {
                                const bookOption = document.createElement("option");
                                bookOption.value = book.bookName;
                                bookOption.textContent = book.bookName;
                                bookSelect.appendChild(bookOption);
                            }
                        });
                    }
                } catch (error) {
                    console.error("Kitap listesi yükleme hatası:", error);
                    await showAlert("Kitap listesi yükleme hatası: " + error.message);
                }
            }

            // "Teslim Et" butonlarının durumunu günceller
            function updateReturnButtons() {
                const returnButtons = document.querySelectorAll(".return-book");
                returnButtons.forEach(button => {
                    if (button.classList.contains("completed")) {
                        // Teslim edilmiş kitaplar için buton zaten yeşil ve disabled
                        button.disabled = true;
                    } else {
                        // Teslim edilmemiş kitaplar için butonun durumu edit moduna bağlı
                        if (isEditMode) {
                            button.disabled = false;
                        } else {
                            button.disabled = true;
                        }
                    }
                });

                // Silme butonlarını güncelle
                const deleteButtons = document.querySelectorAll(".delete-assignment");
                deleteButtons.forEach(button => {
                    if (isEditMode) {
                        button.style.display = "inline-block";
                    } else {
                        button.style.display = "none";
                    }
                });
            }

            editButton.addEventListener("click", () => {
                // Düzenle butonuna basıldığında PIN girişi tekrar gösterilsin.
                pinSection.style.display = "block";
                editSection.style.display = "none";
                isEditMode = false;
                mainElement.classList.remove("edit-mode"); // 'edit-mode' sınıfını kaldır
                updateReturnButtons();
                pinInput.value = "";
            });

            pinSubmit.addEventListener("click", async () => {
                const enteredPin = pinInput.value;
                if (!classID) {
                    await showAlert("Lütfen bir sınıf seçin.");
                    return;
                }
                const classPinRef = ref(database, 'classes/' + classID + '/pin');
                try {
                    const snapshot = await get(classPinRef);
                    if (snapshot.exists()) {
                        const correctPin = snapshot.val();
                        if (enteredPin === correctPin) {
                            pinSection.style.display = "none";
                            editSection.style.display = "block";
                            isEditMode = true;
                            mainElement.classList.add("edit-mode"); // 'edit-mode' sınıfını ekle
                            await loadDataFromFirebase(); // Butonları güncellemek için verileri tekrar yükle
                        } else {
                            await showAlert("Yanlış PIN!");
                        }
                    } else {
                        await showAlert("Bu sınıf için PIN tanımlı değil.");
                    }
                } catch (error) {
                    console.error("PIN doğrulama hatası:", error);
                    await showAlert("PIN doğrulama hatası: " + error.message);
                }
            });

            // Öğrenci ekle
            addStudentButton.addEventListener("click", async () => {
                const studentName = document.getElementById("new-student-name").value.trim();
                if (studentName) {
                    const newStudentRef = push(ref(database, 'classes/' + classID + '/students'));
                    try {
                        await set(newStudentRef, {
                            studentName: studentName
                        });
                        console.log("Öğrenci başarıyla kaydedildi.");
                        const option = document.createElement("option");
                        option.value = studentName;
                        option.textContent = studentName;
                        studentSelect.appendChild(option);

                        const historyOption = document.createElement("option");
                        historyOption.value = studentName;
                        historyOption.textContent = studentName;
                        studentHistorySelect.appendChild(historyOption);

                        await loadDataFromFirebase();
                        await loadStudents();
                        document.getElementById("new-student-name").value = "";
                    } catch (error) {
                        console.error("Öğrenci kaydetme hatası:", error);
                        await showAlert("Öğrenci kaydetme hatası: " + error.message);
                    }
                } else {
                    await showAlert("Lütfen bir öğrenci adı girin!");
                }
            });

            // Öğrenci sil
            deleteStudentButton.addEventListener("click", async () => {
                const studentName = document.getElementById("new-student-name").value.trim();
                if (!studentName) {
                    await showAlert("Lütfen bir öğrenci adı girin!");
                    return;
                }

                const confirmDelete = await showConfirm("Bu öğrenciyi silmek istediğinize emin misiniz?");
                if (!confirmDelete) {
                    return;
                }

                const studentsRef = ref(database, 'classes/' + classID + '/students');
                try {
                    const snapshot = await get(studentsRef);
                    if (snapshot.exists()) {
                        const studentsData = snapshot.val();
                        let studentKeyToRemove = null;
                        for (let key in studentsData) {
                            if (studentsData[key].studentName === studentName) {
                                studentKeyToRemove = key;
                                break;
                            }
                        }

                        if (studentKeyToRemove) {
                            await remove(ref(database, 'classes/' + classID + '/students/' + studentKeyToRemove));
                            console.log("Öğrenci başarıyla silindi.");

                            const studentIndex = Array.from(studentSelect.options).findIndex(option => option.value === studentName);
                            if (studentIndex > -1) {
                                studentSelect.remove(studentIndex);
                            }

                            const historyIndex = Array.from(studentHistorySelect.options).findIndex(option => option.value === studentName);
                            if (historyIndex > -1) {
                                studentHistorySelect.remove(historyIndex);
                            }

                            const booksRef = ref(database, 'classes/' + classID + '/books');
                            const booksSnapshot = await get(booksRef);
                            if (booksSnapshot.exists()) {
                                const booksData = booksSnapshot.val();
                                const updates = {};
                                for (let bookKey in booksData) {
                                    if (booksData[bookKey].studentName === studentName) {
                                        updates[bookKey] = null; // Silmek için null değeri atanır
                                    }
                                }
                                await update(booksRef, updates);
                            }

                            await loadDataFromFirebase();
                            await loadStudents();
                            document.getElementById("new-student-name").value = "";
                        } else {
                            await showAlert("Öğrenci bulunamadı.");
                        }
                    }
                } catch (error) {
                    console.error("Öğrenci silme hatası:", error);
                    await showAlert("Öğrenci silme hatası: " + error.message);
                }
            });

            // Kitap ekle
            addBookButton.addEventListener("click", async () => {
                const bookName = document.getElementById("new-book-name").value.trim();
                if (bookName) {
                    const newBookRef = push(ref(database, 'classes/' + classID + '/booksList'));
                    try {
                        await set(newBookRef, {
                            bookName: bookName
                        });
                        console.log("Kitap başarıyla kaydedildi.");
                        const option = document.createElement("option");
                        option.value = bookName;
                        option.textContent = bookName;
                        bookSelect.appendChild(option);

                        await loadBooksList();
                        document.getElementById("new-book-name").value = "";
                    } catch (error) {
                        console.error("Kitap kaydetme hatası:", error);
                        await showAlert("Kitap kaydetme hatası: " + error.message);
                    }
                } else {
                    await showAlert("Lütfen bir kitap adı girin!");
                }
            });

            // Kitap sil
            deleteBookButton.addEventListener("click", async () => {
                const bookName = document.getElementById("new-book-name").value.trim();
                if (!bookName) {
                    await showAlert("Lütfen bir kitap adı girin!");
                    return;
                }

                const confirmDelete = await showConfirm("Bu kitabı silmek istediğinize emin misiniz?");
                if (!confirmDelete) {
                    return;
                }

                const booksListRef = ref(database, 'classes/' + classID + '/booksList');
                try {
                    const snapshot = await get(booksListRef);
                    if (snapshot.exists()) {
                        const booksListData = snapshot.val();
                        let bookKeyToRemove = null;
                        for (let key in booksListData) {
                            if (booksListData[key].bookName === bookName) {
                                bookKeyToRemove = key;
                                break;
                            }
                        }

                        if (bookKeyToRemove) {
                            await remove(ref(database, 'classes/' + classID + '/booksList/' + bookKeyToRemove));
                            console.log("Kitap başarıyla silindi.");

                            const bookIndex = Array.from(bookSelect.options).findIndex(option => option.value === bookName);
                            if (bookIndex > -1) {
                                bookSelect.remove(bookIndex);
                            }

                            const booksRef = ref(database, 'classes/' + classID + '/books');
                            const booksSnapshot = await get(booksRef);
                            if (booksSnapshot.exists()) {
                                const booksData = booksSnapshot.val();
                                const updates = {};
                                for (let bookKey in booksData) {
                                    if (booksData[bookKey].bookName === bookName) {
                                        updates[bookKey] = null; // Silmek için null değeri atanır
                                    }
                                }
                                await update(booksRef, updates);
                            }

                            await loadDataFromFirebase();
                            await loadBooksList();
                            document.getElementById("new-book-name").value = "";
                        } else {
                            await showAlert("Kitap bulunamadı.");
                        }
                    }
                } catch (error) {
                    console.error("Kitap silme hatası:", error);
                    await showAlert("Kitap silme hatası: " + error.message);
                }
            });

            // Kitap atama
            assignBookButton.addEventListener("click", async () => {
                const selectedStudent = studentSelect.value;
                const selectedBook = bookSelect.value;
                if (!selectedStudent || !selectedBook) {
                    await showAlert("Lütfen öğrenci ve kitap seçin!");
                    return;
                }
                const booksRef = ref(database, 'classes/' + classID + '/books');
                try {
                    const snapshot = await get(booksRef);
                    let books = [];
                    if (snapshot.exists()) {
                        books = Object.values(snapshot.val());
                    }
                    const hasReadBefore = books.some(book => book.studentName === selectedStudent && book.bookName === selectedBook);
                    if (hasReadBefore) {
                        const confirmAssign = await showConfirm("Bu kitap daha önce okundu. Emin misiniz?");
                        if (!confirmAssign) {
                            return;
                        }
                    }
                    const borrowDate = formatDate(new Date());
                    const newBookRef = push(booksRef);
                    await set(newBookRef, {
                        studentName: selectedStudent,
                        bookName: selectedBook,
                        borrowDate: borrowDate,
                        status: "okuyor"
                    });
                    console.log("Kitap başarıyla atandı.");
                    await loadDataFromFirebase();
                } catch (error) {
                    console.error("Kitap atama hatası:", error);
                    await showAlert("Kitap atama hatası: " + error.message);
                }
            });

            // Kitap teslim et ve silme butonları için event listener
            booksTableBody.addEventListener("click", async (e) => {
                // Teslim Et butonuna tıklanması durumunda
                if (e.target.classList.contains("return-book") && !e.target.disabled && !e.target.classList.contains("completed")) {
                    const row = e.target.closest("tr");
                    const studentName = row.children[0].textContent;
                    const bookName = row.children[1].textContent;

                    const booksRef = ref(database, 'classes/' + classID + '/books');
                    try {
                        const snapshot = await get(booksRef);
                        if (snapshot.exists()) {
                            const booksData = snapshot.val();
                            let bookKeyToUpdate = null;
                            for (let key in booksData) {
                                if (booksData[key].studentName === studentName && booksData[key].bookName === bookName && booksData[key].status === "okuyor") {
                                    bookKeyToUpdate = key;
                                    break;
                                }
                            }

                            if (bookKeyToUpdate) {
                                const returnDate = formatDate(new Date());
                                await update(ref(database, `classes/${classID}/books/${bookKeyToUpdate}`), { 
                                    status: "tamamlandı",
                                    returnDate: returnDate
                                });
                                console.log("Kitap teslim edildi.");
                                await loadDataFromFirebase();
                            } else {
                                await showAlert("Kitap bulunamadı veya zaten teslim edilmiş.");
                            }
                        }
                    } catch (error) {
                        console.error("Kitap teslim etme hatası:", error);
                        await showAlert("Kitap teslim etme hatası: " + error.message);
                    }
                }

                // Silme butonuna tıklanması durumunda
                if (e.target.classList.contains("delete-assignment")) {
                    const row = e.target.closest("tr");
                    const bookKey = row.getAttribute('data-key');

                    if (!bookKey) {
                        await showAlert("Silinecek kitap ataması bulunamadı.");
                        return;
                    }

                    const confirmDelete = await showConfirm("Bu kitap atamasını silmek istediğinize emin misiniz?");
                    if (!confirmDelete) {
                        return;
                    }

                    const bookRef = ref(database, `classes/${classID}/books/${bookKey}`);
                    try {
                        await remove(bookRef);
                        console.log("Kitap ataması başarıyla silindi.");
                        await loadDataFromFirebase();
                        // "En İyiler" ve "Öğrenci Kitap Geçmişi" bölümlerini de güncellemek için gerekli fonksiyonları çağırın
                        // Örneğin:
                        // await loadBestSection();
                        // await loadReadingHistory();
                    } catch (error) {
                        console.error("Kitap ataması silme hatası:", error);
                        await showAlert("Kitap ataması silme hatası: " + error.message);
                    }
                }
            });

            // Öğrenci geçmişi listele
            listHistoryButton.addEventListener("click", async () => {
                const selectedStudent = studentHistorySelect.value;
                if (!selectedStudent) {
                    await showAlert("Lütfen bir öğrenci seçin!");
                    return;
                }
                const booksRef = ref(database, 'classes/' + classID + '/books');
                try {
                    const snapshot = await get(booksRef);
                    if (snapshot.exists()) {
                        const books = Object.values(snapshot.val()).filter(book => book.studentName === selectedStudent);
                        // Teslim tarihine göre sıralama
                        books.sort((a, b) => {
                            const dateA = a.returnDate ? parseDate(a.returnDate) : new Date(0);
                            const dateB = b.returnDate ? parseDate(b.returnDate) : new Date(0);
                            return dateB - dateA;
                        });
                        readingHistoryBody.innerHTML = "";
                        books.forEach(book => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td>${book.bookName}</td>
                                <td>${book.borrowDate}</td>
                                <td>${book.status === "tamamlandı" ? book.returnDate : "-"}</td>
                            `;
                            readingHistoryBody.appendChild(row);
                        });
                        readingHistoryTable.style.display = "table";
                        readingHistorySection.style.display = "block";
                    } else {
                        readingHistoryBody.innerHTML = "";
                        readingHistoryTable.style.display = "none";
                        readingHistorySection.style.display = "block"; // Show section even if no data
                        await showAlert("Seçilen öğrencinin geçmişi bulunmamaktadır.");
                    }
                } catch (error) {
                    console.error("Veri yükleme hatası:", error);
                    await showAlert("Veri yükleme hatası: " + error.message);
                }
            });

            // En iyiler
            bestButton.addEventListener("click", async () => {
                if (bestSection.style.display === "block") {
                    bestSection.style.display = "none";
                } else {
                    bestSection.style.display = "block";
                    bestSection.innerHTML = "<h3>En İyiler</h3><table id='best-table'><thead><tr><th>Öğrenci Adı</th><th>Okunan Kitap Sayısı</th></tr></thead><tbody></tbody></table>";
                    const bestTableBody = document.querySelector("#best-table tbody");
                    const booksRef = ref(database, 'classes/' + classID + '/books');
                    try {
                        const snapshot = await get(booksRef);
                        if (snapshot.exists()) {
                            const books = Object.values(snapshot.val());
                            const studentCounts = {};
                            books.forEach(book => {
                                if (book.studentName) {
                                    studentCounts[book.studentName] = (studentCounts[book.studentName] || 0) + 1;
                                }
                            });
                            const sortedStudents = Object.entries(studentCounts).sort((a, b) => b[1] - a[1]);
                            bestTableBody.innerHTML = "";
                            sortedStudents.forEach(([studentName, count], index) => {
                                const row = document.createElement("tr");
                                row.innerHTML = `<td>${studentName}</td><td>${count}</td>`;
                                if (index < 3) {
                                    row.classList.add("top-three");
                                }
                                bestTableBody.appendChild(row);
                            });
                        } else {
                            bestTableBody.innerHTML = "<tr><td colspan='2'>Veri bulunmamaktadır.</td></tr>";
                        }
                    } catch (error) {
                        console.error("Veri yükleme hatası:", error);
                        await showAlert("Veri yükleme hatası: " + error.message);
                    }
                }
            });

            // Tarihçe butonu
            historyButton.addEventListener("click", () => {
                if (readingHistorySection.style.display === "block") {
                    readingHistorySection.style.display = "none";
                } else {
                    readingHistorySection.style.display = "block";
                }
            });

            // Kaydet butonu
            saveButton.addEventListener("click", async () => {
                editSection.style.display = "none";
                pinSection.style.display = "none";
                isEditMode = false;
                mainElement.classList.remove("edit-mode"); // 'edit-mode' sınıfını kaldır
                await loadDataFromFirebase(); // Butonları güncellemek için verileri tekrar yükle
                await showAlert("Değişiklikler kaydedildi!");
            });

            // Sayfa yüklenince varsayılan sınıfın verilerini yükles
            // İlk sınıf seçilmediği için kullanıcıdan sınıf seçmesini bekliyoruz
        });
    </script>
</head>
<body>
<header>
<h1>
            Tersane İlkokulu Kitaplık Sistemi
            <img alt="Kitap Kurdu" src="https://cdn.pixabay.com/photo/2013/07/12/17/11/bookworm-151738_1280.png"/>
</h1>
</header>
<main>
<div style="text-align: center; margin-top: 20px;">
<label for="class-select">Sınıf Seçin:</label>
<select id="class-select">
<!-- Sınıflar Firebase üzerinden yüklenecek -->
<option value="">Sınıf Seçin</option>
</select>
</div>
<div style="text-align: center; margin-top: 20px;">
<button id="edit-button">Düzenle</button><div id="pin-section" style="display: none;">
<label for="pin-input">PIN:</label>
<input id="pin-input" type="password"/> <!-- maxlength kaldırıldı veya artırıldı -->
<button id="pin-submit">Onayla</button>
</div><div id="edit-section">
<h3>Öğrenci ve Kitap Yönetimi</h3>
<div id="student-book-management">
<div>
<h4>Öğrenci Ekle</h4>
<input id="new-student-name" placeholder="Öğrenci Adı" type="text"/>
<button id="add-student">Ekle</button>
<button class="delete-button" id="delete-student">Sil</button>
</div>
<div>
<h4>Kitap Ekle</h4>
<input id="new-book-name" placeholder="Kitap Adı" type="text"/>
<button id="add-book">Ekle</button>
<button class="delete-button" id="delete-book">Sil</button>
</div>
<div style="margin-top: 2em;">
<h4>Kitap Atama</h4>
<select id="student-select">
<option value="">Öğrenci Seçin</option>
</select>
<select id="book-select">
<option value="">Kitap Seçin</option>
</select>
<button id="assign-book">Ata</button>
</div>
</div>
<button id="save-button">Kaydet</button>
</div>
<button id="best-button">En İyiler</button>
<button id="history-button">Öğrenci Kitap Geçmişi</button>
</div>
<section id="best-section" style="display: none; text-align: center; margin-top: 20px;">
<h3>En İyiler</h3>
<table id="best-table">
<thead>
<tr><th>Öğrenci Adı</th><th>Okunan Kitap Sayısı</th></tr>
</thead>
<tbody></tbody>
</table>
</section>
<section id="reading-history-section" style="display: none; text-align: center; margin-top: 20px;">
<h3>Öğrenci Kitap Geçmişi</h3>
<select id="student-history-select">
<option value="">Öğrenci Seçin</option>
</select>
<button id="list-history">Listele</button>
<table id="reading-history-table" style="display: none;">
<thead>
<tr><th>Kitap İsmi</th><th>Alış Tarihi</th><th>Teslim Tarihi</th></tr>
</thead>
<tbody id="reading-history"></tbody>
</table>
</section>
<section id="book-list">
<table>
<thead>
<tr>
<th>Öğrenci Adı</th>
<th>Okuduğu Kitap İsmi</th>
<th>Kitabı Aldığı Tarih</th>
<th>Okuma Durumu</th>
<th class="action-column">İşlemler</th> <!-- "İşlemler" sütunu -->
</tr>
</thead>
<tbody id="books">
<!-- Dinamik olarak kitap bilgileri burada yer alacak -->
</tbody>
</table>
</section>

</main>
<!-- Modal Dialog -->
<dialog id="modal">
<div id="modal-content">
<p id="modal-message"></p>
<input id="modal-input" type="text"/>
<div id="modal-buttons">
<button class="ok-btn">Tamam</button>
<button class="cancel-btn" style="display: none;">İptal</button>
<button class="confirm-btn" style="display: none;">Onayla</button>
</div>
</div>
</dialog>
</body>
</html>
